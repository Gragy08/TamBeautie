extends ../layouts/default.pug

block main
  // Thống kê tổng hợp toàn bộ
  .row.mb-4
    .col-md-12
      .card
        .card-header.bg-primary.text-white
          h4.mb-0 Thống kê tổng hợp toàn bộ
        .card-body
          .row
            .col-md-3
              h5 Tổng doanh thu
              p.mb-2.text-success.fs-4 #{totalRevenue.toLocaleString('vi-VN')}.000.₫
            .col-md-3
              h5 Tổng số đơn khám
              p.mb-2.text-dark.fs-4.fw-bold #{totalBookings}
            .col-md-3
              h5 Top 5 dịch vụ best seller
              ul.mb-2
                each sv in topServices
                  li #{sv.name} (#{sv.count} lần)
            .col-md-3
              h5 Top 5 khách hàng thân thiết
              ul.mb-2
                each cus in topCustomers
                  li #{cus.fullName} (#{cus.phone}) - #{cus.count} đơn
                      
  // Thống kê tổng hợp tháng này
  .row.mb-4
    .col-md-12
      .card
        .card-header.bg-info.text-white
          h4.mb-0 Thống kê tháng #{(new Date()).getMonth() + 1}/#{(new Date()).getFullYear()}
        .card-body
          .row
            .col-md-3
              h5 Doanh thu tháng
              p.mb-2.text-success.fs-4 #{monthlyRevenue.toLocaleString('vi-VN')}.000.₫
            .col-md-3
              h5 Khách sinh nhật tháng này
              if birthdayCustomers.length
                ul.mb-2
                  each cus in birthdayCustomers
                    li #{cus.fullName} - #{cus.phone} (#{cus.dob ? (new Date(cus.dob)).toLocaleDateString('vi-VN') : ''})
              else
                p.text-muted Không có khách nào
            .col-md-3
              h5 Top 5 dịch vụ
              ul.mb-2
                each sv in topServices
                  li #{sv.name} (#{sv.count} lần)
            .col-md-3
              h5 Đơn khám 7 ngày gần nhất
              if bookingsThisMonth.length
                ul.mb-2
                  each b in bookingsThisMonth
                    li #{b.customerName} - #{b.customerPhone} (#{b.date ? (new Date(b.date)).toLocaleDateString('vi-VN') : ''})
              else
                p.text-muted Không có đơn khám nào
  // Tổng doanh thu tháng (có biểu đồ) + tổng doanh thu toàn bộ + tổng đơn khám toàn bộ
  .row.mb-4
    .col-md-12.col-lg-8
      .card
        .card-header.d-flex.justify-content-between.align-items-center
          h4.card-title.mb-0 Doanh thu theo tháng
          .d-flex.align-items-center
            label.me-2(for="monthSelect") Chọn tháng:
            select#monthSelect.form-select.form-select-sm(style="width: auto; display: inline-block;")
              - const months = Object.keys(monthlyDailyRevenue || {});
              each m in months.sort().reverse()
                option(value=m selected=(m === `${(new Date()).getFullYear()}-${((new Date()).getMonth()+1).toString().padStart(2,'0')}`))
                  = m.split('-')[1] + '/' + m.split('-')[0]
        .card-body.pt-0
          #monthly_revenue_chart.apex-charts(style="min-height: 250px;")
          .row.mt-3
            .col-md-6
              h2.fs-22.mt-0.mb-1.fw-bold#monthlyRevenueText #{monthlyRevenue.toLocaleString('vi-VN')} ₫
              p.mb-0.text-truncate.text-muted Tổng doanh thu tháng này
            .col-md-6
              .d-flex.flex-column.align-items-end
                h6 Tổng doanh thu toàn bộ:
                h4.text-success.mb-1 #{totalRevenue.toLocaleString('vi-VN')}.000 ₫
                h6 Tổng số đơn khám toàn bộ:
                h4.mb-2.text-dark.fs-4.fw-bold #{totalBookings}
    .col-md-12.col-lg-4
      .card
        .card-header
          h4.card-title.mb-0 Top 5 dịch vụ khách dùng nhiều nhất
        .card-body.pt-0
          if topServices.length
            table.table.table-sm
              thead
                tr
                  th Dịch vụ
                  th Số lần sử dụng
              tbody
                each sv in topServices
                  tr
                    td #{sv.name}
                    td #{sv.count}
          else
            p.text-muted Không có dữ liệu

  .row
    .col-md-6.col-lg-4
      .card
        .card-header
          h4.card-title Khách sinh nhật tháng này
        .card-body.pt-0
          if birthdayCustomers.length
            table.table.table-sm
              thead
                tr
                  th Họ tên
                  th SĐT
                  th Ngày sinh
              tbody
                each cus in birthdayCustomers
                  tr
                    td #{cus.fullName}
                    td #{cus.phone}
                    td #{cus.dob ? (new Date(cus.dob)).toLocaleDateString('vi-VN') : ''}
          else
            p.text-muted Không có khách nào
    .col-md-6.col-lg-8
      .card
        .card-header
          h4.card-title Đơn khám tháng này
        .card-body.pt-0
          if bookingsThisMonth.length
            table.table.table-sm
              thead
                tr
                  th Họ tên
                  th SĐT
                  th Ngày khám
                  th Tổng tiền
              tbody
                each b in bookingsThisMonth
                  tr
                    td #{b.customerName}
                    td #{b.customerPhone}
                    td #{b.date ? (new Date(b.date)).toLocaleDateString('vi-VN') : ''}
                    td #{b.pay ? b.pay.toLocaleString('vi-VN') + '.000' + ' ₫' : ''}
          else
            p.text-muted Không có đơn khám nào

block script
  script(src="/admin/assets/libs/apexcharts/apexcharts.min.js")
  script.
    // Truyền dữ liệu doanh thu từng tháng từ backend sang JS
    window.monthlyDailyRevenue = !{JSON.stringify(monthlyDailyRevenue || {})};
    window.monthlyRevenue = !{JSON.stringify(monthlyRevenue)};
    window.monthlyRevenueMap = {};
    // Tính sẵn tổng doanh thu từng tháng
    for (const m in window.monthlyDailyRevenue) {
      window.monthlyRevenueMap[m] = (window.monthlyDailyRevenue[m]||[]).reduce((a,b)=>a+b,0);
    }
    document.addEventListener('DOMContentLoaded', function() {
      var chart;
      var $select = document.getElementById('monthSelect');
      function renderChart(monthKey) {
        var data = window.monthlyDailyRevenue[monthKey] || [];
        var daysInMonth = data.length;
        var options = {
          chart: { type: 'bar', height: 250 },
          series: [{ name: 'Doanh thu', data: data }],
          xaxis: { categories: Array.from({length: daysInMonth}, (_, i) => i + 1) },
          yaxis: { labels: { formatter: val => val.toLocaleString('vi-VN') + ' ₫' } },
          colors: ['#F59DC3']
        };
        if (window.ApexCharts) {
          if (chart) chart.destroy();
          chart = new ApexCharts(document.querySelector('#monthly_revenue_chart'), options);
          chart.render();
        }
        // Cập nhật tổng doanh thu tháng
        var revenue = window.monthlyRevenueMap[monthKey] || 0;
        document.getElementById('monthlyRevenueText').textContent = revenue.toLocaleString('vi-VN') + ' ₫';
      }
      if ($select) {
        $select.addEventListener('change', function() {
          renderChart(this.value);
        });
        // Hiển thị tháng hiện tại mặc định
        renderChart($select.value);
      }
    });